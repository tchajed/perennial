(* autogenerated from github.com/tchajed/simplefs/alloc *)
From Perennial.goose_lang Require Import prelude.
From Goose Require github_com.tchajed.simplefs.
From Goose Require github_com.tchajed.simplefs.bitmap.
From Goose Require github_com.tchajed.simplefs.inode.
From Goose Require github_com.tchajed.simplefs.superblock.

From Perennial.goose_lang Require Import ffi.disk_prelude.

Definition BlockAllocator := struct.decl [
  "offset" :: uint64T;
  "bitmap" :: struct.t bitmap.Bitmap;
  "free" :: slice.T uint32T;
  "d" :: disk.Disk
].

Definition NewBlockAllocator: val :=
  rec: "NewBlockAllocator" "d" "sb" :=
    let: "offset" := superblock.Superblock__DataBitmapStart "sb" in
    let: "bm" := bitmap.NewBitmapFromBlocks "d" "offset" (struct.loadF superblock.Superblock "DataBitmapBlocks" "sb") in
    let: "free" := ref_to (slice.T uint32T) (NewSlice uint32T #0) in
    let: "blks" := struct.loadF superblock.Superblock "DataBlocks" "sb" in
    let: "i" := ref_to uint64T #1 in
    (for: (λ: <>, (![uint64T] "i") < "blks"); (λ: <>, "i" <-[uint64T] ((![uint64T] "i") + #1)) := λ: <>,
      (if: (~ (bitmap.Bitmap__Get "bm" (![uint64T] "i")))
      then
        "free" <-[slice.T uint32T] (SliceAppend uint32T (![slice.T uint32T] "free") (to_u32 (![uint64T] "i")));;
        Continue
      else Continue));;
    struct.new BlockAllocator [
      "offset" ::= "offset";
      "bitmap" ::= "bm";
      "free" ::= ![slice.T uint32T] "free";
      "d" ::= "d"
    ].

Definition BlockAllocator__Alloc: val :=
  rec: "BlockAllocator__Alloc" "ba" :=
    (if: (slice.len (struct.loadF BlockAllocator "free" "ba")) = #0
    then (#(U32 0), #false)
    else
      let: "i" := SliceGet uint32T (struct.loadF BlockAllocator "free" "ba") ((slice.len (struct.loadF BlockAllocator "free" "ba")) - #1) in
      struct.storeF BlockAllocator "free" "ba" (SliceTake (struct.loadF BlockAllocator "free" "ba") ((slice.len (struct.loadF BlockAllocator "free" "ba")) - #1));;
      bitmap.Bitmap__Set (struct.loadF BlockAllocator "bitmap" "ba") (to_u64 "i");;
      bitmap.Bitmap__Write (struct.loadF BlockAllocator "bitmap" "ba") (struct.loadF BlockAllocator "d" "ba") (struct.loadF BlockAllocator "offset" "ba");;
      ("i", #true)).

Definition BlockAllocator__Free: val :=
  rec: "BlockAllocator__Free" "ba" "i" :=
    (if: (~ (bitmap.Bitmap__Get (struct.loadF BlockAllocator "bitmap" "ba") (to_u64 "i")))
    then Panic "freeing free block"
    else #());;
    bitmap.Bitmap__Clear (struct.loadF BlockAllocator "bitmap" "ba") (to_u64 "i");;
    bitmap.Bitmap__Write (struct.loadF BlockAllocator "bitmap" "ba") (struct.loadF BlockAllocator "d" "ba") (struct.loadF BlockAllocator "offset" "ba");;
    struct.storeF BlockAllocator "free" "ba" (SliceAppend uint32T (struct.loadF BlockAllocator "free" "ba") "i");;
    #().

Definition InodeAllocator := struct.decl [
  "sb" :: ptrT;
  "d" :: disk.Disk;
  "free" :: slice.T simplefs.Inum
].

Definition NewInodeAllocator: val :=
  rec: "NewInodeAllocator" "d" "sb" :=
    let: "free" := ref_to (slice.T simplefs.Inum) (NewSlice simplefs.Inum #0) in
    let: "i" := ref_to uint64T #0 in
    (for: (λ: <>, (![uint64T] "i") < (superblock.Superblock__NumInodes "sb")); (λ: <>, "i" <-[uint64T] ((![uint64T] "i") + #1)) := λ: <>,
      let: "inum" := ![uint64T] "i" in
      let: "ino" := inode.ReadInode "d" "sb" "inum" in
      (if: (inode.Inode__GetType "ino") = simplefs.Invalid
      then
        "free" <-[slice.T simplefs.Inum] (SliceAppend simplefs.Inum (![slice.T simplefs.Inum] "free") "inum");;
        Continue
      else Continue));;
    struct.new InodeAllocator [
      "sb" ::= "sb";
      "d" ::= "d";
      "free" ::= ![slice.T simplefs.Inum] "free"
    ].

Definition InodeAllocator__Alloc: val :=
  rec: "InodeAllocator__Alloc" "ia" "ty" :=
    control.impl.Assert ("ty" ≠ simplefs.Invalid);;
    (if: (slice.len (struct.loadF InodeAllocator "free" "ia")) = #0
    then (#0, #false)
    else
      let: "i" := SliceGet simplefs.Inum (struct.loadF InodeAllocator "free" "ia") ((slice.len (struct.loadF InodeAllocator "free" "ia")) - #1) in
      struct.storeF InodeAllocator "free" "ia" (SliceTake (struct.loadF InodeAllocator "free" "ia") ((slice.len (struct.loadF InodeAllocator "free" "ia")) - #1));;
      let: "ino" := inode.ReadInode (struct.loadF InodeAllocator "d" "ia") (struct.loadF InodeAllocator "sb" "ia") "i" in
      inode.Inode__SetType "ino" "ty";;
      inode.Inode__Write "ino" (struct.loadF InodeAllocator "d" "ia") (struct.loadF InodeAllocator "sb" "ia") "i";;
      ("i", #true)).

Definition InodeAllocator__Free: val :=
  rec: "InodeAllocator__Free" "ia" "i" :=
    let: "ino" := inode.ReadInode (struct.loadF InodeAllocator "d" "ia") (struct.loadF InodeAllocator "sb" "ia") "i" in
    inode.Inode__SetType "ino" simplefs.Invalid;;
    inode.Inode__Write "ino" (struct.loadF InodeAllocator "d" "ia") (struct.loadF InodeAllocator "sb" "ia") "i";;
    struct.storeF InodeAllocator "free" "ia" (SliceAppend simplefs.Inum (struct.loadF InodeAllocator "free" "ia") "i");;
    #().
